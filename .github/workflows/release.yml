name: Trigger auto deployment for mortcal

on:
  push:
    branches: 
      [ "main" ]
  release:
    types: [published]     
  workflow_dispatch: 

env:
  IMAGE_NAME: mortcal
  RG_STG: mortcal-stg-rg
  ACA_ENV_STG: mortcal-stg-env
  ACA_APP_STG: mortcal-stg
  RG_Prod: mortcal-prod-rg
  ACA_ENV_PROD: managedEnvironment-120325MortCal-a394
  ACA_APP_PROD: mortcal

jobs:
  pull_from_registry:
    name: Pull Docker image from Docker Hub
    runs-on: ubuntu-latest
    permissions:
      packages: read
      contents: read
      attestations: read
      id-token: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Docker Hub Login
      uses: docker/login-action@v2
      with: 
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    

    - name: Pull the Docker image
      run: |
        docker pull tiggy081/$IMAGE_NAME:latest

  deploy-stg:
    name: Deploy to STG  ACA
    needs: pull_from_registry
    runs-on: ubuntu-latest
    
    steps:
    - name: Login to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy to ACA (STG)
      run: | 
        az containerapp update \
          --name $ACA_APP_STG \
          --resource-group $RESOURCE_GROUP \
          --image tiggy081/$IMAGE_NAME:latest
    
  deploy-prod:
    name: Deploy PROD to ACA
    needs: deploy-stg
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with: 
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to ACA (prod)
        run: |
          az containerapp update \
            --name $ACA_APP_PROD \
            --resource-group $RESOURCE_GROUP \
            --image $ACR_NAME.azurecr.io/$IMAGE_NAME:prod
